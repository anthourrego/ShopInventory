// Variables globales
let bannerSwiper, categoriesSwiper, productSwiper;
let productsFromJSON = []; // Array para almacenar productos del JSON

// Funci√≥n para cargar productos desde JSON
async function loadProductsFromJSON() {
    try {
        console.log('üîÑ Cargando productos desde JSON...');
        const response = await fetch('assets/products.json');
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        const products = await response.json();
        
        // Validar y agregar im√°genes por defecto si no existen
        productsFromJSON = products.map(product => ({
            ...product,
            images: product.images || ['assets/placeholder.svg'],
            // Asegurar que siempre tenga al menos una imagen
            category: product.category || 'sin-categoria'
        }));
        
        console.log(`‚úÖ ${productsFromJSON.length} productos cargados desde JSON`);
        
        // Hacer los productos accesibles globalmente - ESTA ES LA FUENTE PRINCIPAL
        window.productsFromJSON = productsFromJSON;
        
        // Tambi√©n actualizar window.products para compatibilidad
        window.products = productsFromJSON;
        
        return productsFromJSON;
    } catch (error) {
        console.error('‚ùå Error cargando productos del JSON:', error);
        console.log('üîÑ Usando productos por defecto como fallback');
        
        // Fallback: usar un array vac√≠o o productos de demostraci√≥n m√≠nimos
        window.productsFromJSON = [];
        window.products = [];
        
        return [];
    }
}

// Mapeo de categor√≠as a √≠conos y nombres de visualizaci√≥n
const categoryConfig = {
    'Ropa deportiva': {
        icon: 'fas fa-running',
        display: 'Ropa Deportiva'
    },
    'Sin categoria': {
        icon: 'fas fa-shopping-bag',
        display: 'Otros'
    },
    'Suplementos': {
        icon: 'fas fa-pills',
        display: 'Suplementos'
    }
};

// Funci√≥n para renderizar las categor√≠as obtenidas desde el endpoint
function renderCategories(categories) {
    const categoriesWrapper = document.querySelector('.categories-swiper .swiper-wrapper');
    if (!categoriesWrapper) {
        console.error('‚ùå Contenedor de categor√≠as no encontrado.');
        return;
    }

    // Limpia las categor√≠as existentes (excepto "Todos") antes de agregar las nuevas
    const dynamicSlides = categoriesWrapper.querySelectorAll('.swiper-slide:not(:first-child)');
    dynamicSlides.forEach(slide => slide.remove());

    categories.forEach(category => {
        // Asumo que el objeto category tiene una propiedad 'name'
        const categoryName = category.name;
        const config = categoryConfig[categoryName] || { icon: 'fas fa-tag', display: categoryName };
        
        // Crear slug para data-category (normalizar nombre)
        const categorySlug = categoryName.toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[√°√†√§√¢]/g, 'a')
            .replace(/[√©√®√´√™]/g, 'e')
            .replace(/[√≠√¨√Ø√Æ]/g, 'i')
            .replace(/[√≥√≤√∂√¥]/g, 'o')
            .replace(/[√∫√π√º√ª]/g, 'u')
            .replace(/[√±]/g, 'n')
            .replace(/[^a-z0-9-]/g, '');

        const slideHTML = `
            <div class="swiper-slide">
                <div class="category-item" data-category="${categorySlug}" data-original-category="${categoryName}">
                    <div class="category-icon">
                        <i class="${config.icon}"></i>
                    </div>
                    <span>${config.display}</span>
                </div>
            </div>
        `;
        categoriesWrapper.insertAdjacentHTML('beforeend', slideHTML);
    });

    console.log(`‚úÖ ${categories.length} categor√≠as cargadas desde el endpoint.`);
    
    // Actualizar Swiper despu√©s de agregar las categor√≠as
    if (categoriesSwiper) {
        categoriesSwiper.update();
        console.log('üîÑ Swiper de categor√≠as actualizado');
    }
}

// Nueva funci√≥n para obtener y renderizar las categor√≠as desde el endpoint
async function fetchAndRenderCategories() {
    const endpoint = 'http://inventorysystem/getCategories';
    console.log(`üîÑ Cargando categor√≠as desde ${endpoint}...`);
    try {
        const response = await fetch(endpoint);

        if (!response.ok) {
            throw new Error(`Error en la red: ${response.status} ${response.statusText}`);
        }

        const categories = await response.json();

        console.log(categories);

        if (Array.isArray(categories)) {
            renderCategories(categories);
        } else {
            console.error('‚ùå La respuesta del endpoint de categor√≠as no es un array v√°lido.');
        }

    } catch (error) {
        console.error('‚ùå Error al cargar las categor√≠as:', error);
        const categoriesWrapper = document.querySelector('.categories-swiper .swiper-wrapper');
        if (categoriesWrapper) {
             console.error('No se pudieron cargar las categor√≠as. El contenedor de categor√≠as podr√≠a estar vac√≠o.');
        }
    }
}

// Inicializaci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', async function() {
    console.log('DOM loaded, initializing app...');
    
    // Cargar productos y categor√≠as en paralelo
    await Promise.all([
        loadProductsFromJSON(),
        fetchAndRenderCategories()
    ]);
    
    initializeSwiper();
    initializeEventListeners();
    
    // Cargar productos iniciales despu√©s de que los datos est√©n listos
    console.log('üöÄ Iniciando carga de productos...');
    loadInitialProducts();
    
    initializeSearch();
    
    // Test function - esto se puede quitar despu√©s
    window.testModal = function() {
        console.log('Testing modal...');
        openProductModal(1);
    };
    
    console.log('App initialized successfully');
});

// Funci√≥n para inicializar Swiper
function initializeSwiper() {
    // Banner principal
    bannerSwiper = new Swiper('.banner-swiper', {
        loop: true,
        autoplay: {
            delay: 4000,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        effect: 'fade',
        fadeEffect: {
            crossFade: true
        }
    });

    // Categor√≠as
    categoriesSwiper = new Swiper('.categories-swiper', {
        slidesPerView: 'auto',
        spaceBetween: 10,
        freeMode: true,
        breakpoints: {
            320: {
                slidesPerView: 3,
                spaceBetween: 10
            },
            480: {
                slidesPerView: 4,
                spaceBetween: 15
            },
            768: {
                slidesPerView: 6,
                spaceBetween: 20
            },
            1024: {
                slidesPerView: 8,
                spaceBetween: 20
            }
        }
    });
}

// Funci√≥n para inicializar event listeners
function initializeEventListeners() {
    // Categor√≠as - usar delegaci√≥n de eventos para categor√≠as din√°micas
    const categoriesWrapper = document.querySelector('.categories-swiper .swiper-wrapper');
    if (categoriesWrapper) {
        categoriesWrapper.addEventListener('click', function(e) {
            const categoryItem = e.target.closest('.category-item');
            if (!categoryItem) return;
            
            console.log('üè∑Ô∏è Categor√≠a seleccionada:', categoryItem.dataset.category);
            
            // Remover clase active de todas las categor√≠as
            document.querySelectorAll('.category-item').forEach(cat => cat.classList.remove('active'));
            // Agregar clase active a la categor√≠a seleccionada
            categoryItem.classList.add('active');
            
            // Obtener categor√≠a (usar original si existe, sino usar el slug)
            const categorySlug = categoryItem.dataset.category;
            const originalCategory = categoryItem.dataset.originalCategory || categorySlug;
            
            // Cargar productos de la categor√≠a
            let products;
            if (categorySlug === 'all') {
                products = getProductsByCategory('all');
            } else {
                // Buscar por categor√≠a original para mayor precisi√≥n
                products = getProductsByCategory(originalCategory);
            }
            
            renderProducts(products);
            
            // Actualizar t√≠tulo de secci√≥n
            const sectionTitle = document.querySelector('.section-title h2');
            const categoryName = categoryItem.querySelector('span').textContent;
            
            if (categorySlug === 'all') {
                sectionTitle.textContent = 'Todos los productos';
            } else {
                sectionTitle.textContent = categoryName;
            }
            
            console.log('‚úÖ Productos cargados para categor√≠a:', categoryName);
        });
    }

    // B√∫squeda
    const searchInput = document.querySelector('.search-input');
    const searchBtn = document.querySelector('.search-btn');
    
    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }
    
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
}

// Funci√≥n para realizar b√∫squeda
function performSearch() {
    const searchInput = document.querySelector('.search-input');
    const query = searchInput.value.trim();
    const sectionTitle = document.querySelector('.section-title h2');
    
    if (query.length === 0) {
        loadInitialProducts();
        // Restaurar t√≠tulo original
        sectionTitle.textContent = 'Todos los productos';
        return;
    }
    
    const results = searchProducts(query);
    renderProducts(results);
    
    // Actualizar t√≠tulo
    sectionTitle.textContent = `Resultados para: "${query}"`;
    
    // Remover active de categor√≠as
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
}

// Funci√≥n para inicializar b√∫squeda en tiempo real
function initializeSearch() {
    const searchInput = document.querySelector('.search-input');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.trim();
            const sectionTitle = document.querySelector('.section-title h2');
            
            if (query.length === 0) {
                loadInitialProducts();
                // Restaurar t√≠tulo original
                sectionTitle.textContent = 'Todos los productos';
                return;
            }
            
            if (query.length >= 2) {
                performSearch();
            }
        }, 300);
    });
}

// Event listeners para cerrar modales
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Configurando event listeners del modal...');
    
    // Cerrar modal con bot√≥n X
    const closeModalBtn = document.querySelector('.close-modal');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
            console.log('üîÑ Cerrando modal con bot√≥n X');
            closeProductModal();
        });
        console.log('‚úÖ Bot√≥n X configurado');
    }
    
    // Cerrar modal con overlay
    const overlay = document.getElementById('overlay');
    if (overlay) {
        overlay.addEventListener('click', function() {
            console.log('üîÑ Cerrando modal con overlay');
            closeProductModal();
            closeCartModal();
        });
        console.log('‚úÖ Overlay configurado');
    }
    
    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            console.log('üîÑ Cerrando modal con tecla Escape');
            closeProductModal();
            closeCartModal();
        }
    });
    console.log('‚úÖ Tecla Escape configurada');
});

// Funci√≥n para simular carga de datos
function simulateLoading() {
    const grid = document.getElementById('products-grid');
    grid.innerHTML = '<div class="loading">Cargando productos...</div>';
    
    setTimeout(() => {
        loadInitialProducts();
    }, 1000);
}

// Funci√≥n para crear im√°genes placeholder
function createPlaceholderImages() {
    const placeholders = [
        'https://via.placeholder.com/300x300/ff6b9d/ffffff?text=Producto+1',
        'https://via.placeholder.com/300x300/c44569/ffffff?text=Producto+2',
        'https://via.placeholder.com/300x300/ff9999/ffffff?text=Producto+3'
    ];
    
    return placeholders;
}

// Funci√≥n para manejar errores de carga de im√°genes
function handleImageError(img) {
    img.src = 'assets/placeholder.svg';
    img.onerror = null; // Prevenir bucle infinito
}

// Funci√≥n para scroll suave a secci√≥n
function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
}

// Funci√≥n para lazy loading de im√°genes
function initializeLazyLoading() {
    const images = document.querySelectorAll('img[data-src]');
    
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// Funci√≥n para optimizar rendimiento
function optimizePerformance() {
    // Debounce para resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (bannerSwiper) bannerSwiper.update();
            if (categoriesSwiper) categoriesSwiper.update();
            if (productSwiper) productSwiper.update();
        }, 250);
    });
    
    // Preload de im√°genes cr√≠ticas
    const criticalImages = [
        'assets/logo1.png',
    ];
    
    criticalImages.forEach(src => {
        const img = new Image();
        img.src = src;
    });
}

// Funci√≥n para analytics (placeholder)
function trackEvent(eventName, eventData) {
    console.log('Event tracked:', eventName, eventData);
    // Aqu√≠ se puede integrar Google Analytics, Facebook Pixel, etc.
}

// Funci√≥n para compartir producto
function shareProduct(productId) {
    const product = getProductById(productId);
    if (!product) return;
    
    if (navigator.share) {
        navigator.share({
            title: product.name,
            text: product.description,
            url: `${window.location.origin}?product=${productId}`
        });
    } else {
        // Fallback para navegadores que no soportan Web Share API
        const url = `${window.location.origin}?product=${productId}`;
        navigator.clipboard.writeText(url).then(() => {
            showCartNotification('Enlace copiado al portapapeles');
        });
    }
}

// Inicializar optimizaciones cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    optimizePerformance();
    initializeLazyLoading();
    
    // Verificar si hay un producto espec√≠fico en la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product');
    if (productId) {
        setTimeout(() => {
            openProductModal(parseInt(productId));
        }, 500);
    }
});

// Exportar funciones para uso global
window.shareProduct = shareProduct;
window.trackEvent = trackEvent;
